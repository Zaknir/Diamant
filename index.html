<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamant Accessibile - Stato Percorso</title>
    <style>
        :root { --bg: #ffffff; --text: #000000; --border: #333333; --highlight: #eeeeee; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding: 20px; }
        #game-container { max-width: 800px; margin: auto; }
        .setup-box, .stats-grid, .player-list, #path { border: 2px solid var(--border); padding: 15px; margin-bottom: 20px; }
        .player-row { border-bottom: 1px solid var(--border); padding: 10px 0; }
        .active-turn { background: var(--highlight); font-weight: bold; border: 2px solid var(--text); padding: 5px; }
        .out { color: #666666; font-style: italic; }
        .card { border: 1px solid var(--text); padding: 10px; margin: 5px; display: inline-block; }
        button { padding: 15px 25px; font-size: 1.2rem; cursor: pointer; margin: 10px 5px; border: 2px solid var(--text); background: var(--bg); color: var(--text); font-weight: bold; }
        button:hover { background: var(--text); color: var(--bg); }
        .hidden { display: none; }
        #message { font-size: 1.3rem; font-weight: bold; margin: 20px 0; min-height: 3em; border-left: 8px solid var(--border); padding-left: 15px; white-space: pre-line; }
    </style>
</head>
<body>

<div id="game-container" role="main">
    <h1>Diamant - Esplorazione Accessibile</h1>

    <div id="setup" class="setup-box">
        <h2>Configurazione Partita</h2>
        <label for="player-select">Scegli il numero di giocatori:</label>
        <select id="player-select">
            <option value="3">3 Giocatori</option>
            <option value="4">4 Giocatori</option>
            <option value="5">5 Giocatori</option>
            <option value="6">6 Giocatori</option>
            <option value="7">7 Giocatori</option>
            <option value="8">8 Giocatori</option>
        </select>
        <br><br>
        <button onclick="startGame()">Inizia la Partita</button>
    </div>

    <div id="board" class="hidden">
        <div class="stats-grid" role="region" aria-label="Informazioni Round">
            <p>Round attuale: <span id="round-num">1</span> di 5</p>
            <p>Esploratori in grotta: <span id="active-count">0</span></p>
        </div>

        <div id="player-list" class="player-list" role="region" aria-label="Stato Giocatori"></div>
        
        <div id="path" role="region" aria-label="Percorso">
            <h2>Percorso Esplorato:</h2>
            <div id="path-content"></div>
        </div>

        <div id="message" role="alert" aria-live="assertive"></div>

        <div id="controls">
            <div id="action-buttons" class="hidden">
                <button id="btn-continue" onclick="processTurn('continue')">VAI AVANTI</button>
                <button id="btn-leave" onclick="processTurn('leave')">ESCI DALLA GROTTA</button>
            </div>

            <div id="confirm-container" class="hidden">
                <button id="btn-confirm" onclick="prepareTurnChoices()">Prosegui</button>
                <button id="btn-status" onclick="announcePathStatus()">Stato percorso</button>
            </div>

            <div id="next-round-container" class="hidden">
                <button id="btn-next-round" onclick="startRound()">INIZIA PROSSIMO ROUND</button>
            </div>

            <div id="restart-container" class="hidden">
                <button onclick="location.reload()">GIOCA ANCORA</button>
            </div>
        </div>
    </div>
</div>

<script>
    let players = [];
    let currentPlayerIndex = 0;
    let round = 1;
    let activeTraps = [];
    let currentPath = [];
    let roundDecisions = [];

    function startGame() {
        const count = parseInt(document.getElementById('player-select').value);
        players = [];
        for (let i = 1; i <= count; i++) {
            players.push({ id: i, chest: 0, pocket: 0, inCave: true });
        }
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('board').classList.remove('hidden');
        startRound();
    }

    function startRound() {
        if (round > 5) return;
        activeTraps = [];
        currentPath = [];
        players.forEach(p => { p.pocket = 0; p.inCave = true; });
        document.getElementById('path-content').innerHTML = '';
        document.getElementById('round-num').innerText = round;
        document.getElementById('next-round-container').classList.add('hidden');
        prepareTurnChoices();
    }

    function prepareTurnChoices() {
        document.getElementById('confirm-container').classList.add('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
        roundDecisions = [];
        currentPlayerIndex = 0;
        findNextActivePlayer();
    }

    function findNextActivePlayer() {
        while (currentPlayerIndex < players.length && !players[currentPlayerIndex].inCave) {
            currentPlayerIndex++;
        }
        if (currentPlayerIndex < players.length) {
            updateUI(players[currentPlayerIndex].id);
            document.getElementById('message').innerText = "Giocatore " + players[currentPlayerIndex].id + ", scegli: avanti o esci?";
        } else {
            executeTurnLogic();
        }
    }

    function processTurn(decision) {
        roundDecisions.push({ playerId: players[currentPlayerIndex].id, action: decision });
        currentPlayerIndex++;
        findNextActivePlayer();
    }

    function executeTurnLogic() {
        document.getElementById('action-buttons').classList.add('hidden');
        let leavingPlayers = players.filter(p => p.inCave && roundDecisions.find(d => d.playerId === p.id).action === 'leave');
        
        if (leavingPlayers.length > 0) {
            currentPath.forEach(card => {
                if (card.remainder > 0) {
                    let share = Math.floor(card.remainder / leavingPlayers.length);
                    leavingPlayers.forEach(p => p.pocket += share);
                    card.remainder %= leavingPlayers.length;
                }
            });
            leavingPlayers.forEach(p => { p.chest += p.pocket; p.pocket = 0; p.inCave = false; });
        }

        if (players.every(p => !p.inCave)) {
            endRound("Fine del round: tutti i giocatori sono fuori.");
            return;
        }

        const card = drawCard();
        currentPath.push(card);
        let stayingPlayers = players.filter(p => p.inCave);

        if (card.type === 'treasure') {
            let share = Math.floor(card.value / stayingPlayers.length);
            let rest = card.value % stayingPlayers.length;
            card.remainder = rest;
            stayingPlayers.forEach(p => p.pocket += share);
            document.getElementById('message').innerText = "Carta Tesoro: valore " + card.value + ". Ognuno riceve " + share + ". Restano sulla carta " + rest + " diamanti.";
        } else {
            if (activeTraps.includes(card.name)) {
                stayingPlayers.forEach(p => p.pocket = 0);
                endRound("Secondo pericolo: " + card.name + "! Round finito, chi era in grotta perde i diamanti raccolti.");
                return;
            } else {
                activeTraps.push(card.name);
                document.getElementById('message').innerText = "Pericolo: " + card.name + ". Primo avvistamento.";
            }
        }

        updateUI();
        document.getElementById('confirm-container').classList.remove('hidden');
        document.getElementById('btn-confirm').focus();
    }

    function announcePathStatus() {
        if (currentPath.length === 0) {
            document.getElementById('message').innerText = "Il percorso Ã¨ ancora vuoto.";
            return;
        }
        let statusText = "Riepilogo percorso:\n";
        currentPath.forEach((card, index) => {
            statusText += (index + 1) + ". ";
            if (card.type === 'treasure') {
                statusText += "Tesoro: valore iniziale " + card.value + ", restano sopra " + card.remainder + " diamanti.\n";
            } else {
                statusText += "Pericolo: " + card.name + ".\n";
            }
        });
        document.getElementById('message').innerText = statusText;
    }

    function drawCard() {
        const isTrap = Math.random() < 0.35;
        if (!isTrap) {
            return { type: 'treasure', value: Math.floor(Math.random() * 14) + 2, remainder: 0 };
        } else {
            const names = ['Serpente', 'Ragno', 'Fuoco', 'Masso', 'Gas'];
            return { type: 'trap', name: names[Math.floor(Math.random() * names.length)], remainder: 0 };
        }
    }

    function updateUI(highlightId = null) {
        const list = document.getElementById('player-list');
        list.innerHTML = "<h2>Situazione Giocatori:</h2>" + players.map(p => `
            <div class="player-row ${p.id === highlightId ? 'active-turn' : ''} ${!p.inCave ? 'out' : ''}">
                Giocatore ${p.id} - ${p.inCave ? 'In grotta' : 'Uscito'} - Tasca: ${p.pocket}, Baule: ${p.chest}.
            </div>
        `).join('');

        const pathDiv = document.getElementById('path-content');
        pathDiv.innerHTML = currentPath.map(card => `
            <div class="card">
                ${card.type === 'treasure' ? 'Tesoro ' + card.value : 'Pericolo ' + card.name}
                ${card.remainder > 0 ? ' (Resto: ' + card.remainder + ')' : ''}
            </div>
        `).join('');
        document.getElementById('active-count').innerText = players.filter(p => p.inCave).length;
    }

    function endRound(msg) {
        updateUI();
        document.getElementById('message').innerText = msg;
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('confirm-container').classList.add('hidden');
        round++;
        if (round > 5) {
            players.sort((a,b) => b.chest - a.chest);
            document.getElementById('message').innerText = "Fine gara. Vincitore Giocatore " + players[0].id + " con " + players[0].chest + " diamanti.";
            document.getElementById('restart-container').classList.remove('hidden');
        } else {
            document.getElementById('next-round-container').classList.remove('hidden');
        }
    }
</script>
</body>
</html>
