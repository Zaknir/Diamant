<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamant</title>
    <style>
        :root { --bg: #ffffff; --text: #000000; --border: #333333; --highlight: #eeeeee; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding: 20px; }
        #game-container { max-width: 800px; margin: auto; }
        .main-controls { border: 3px solid var(--border); padding: 20px; margin-bottom: 20px; background: #f9f9f9; }
        .setup-box, .info-section, .player-list, #path { border: 2px solid var(--border); padding: 15px; margin-bottom: 20px; }
        .player-row { border-bottom: 1px solid var(--border); padding: 10px 0; }
        .active-turn { background: var(--highlight); font-weight: bold; border: 2px solid var(--text); padding: 5px; }
        .out { color: #666666; font-style: italic; }
        button { padding: 18px 28px; font-size: 1.3rem; cursor: pointer; margin: 10px 5px; border: 2px solid var(--text); background: var(--bg); color: var(--text); font-weight: bold; }
        button:hover { background: var(--text); color: var(--bg); }
        .hidden { display: none; }
        #message { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; white-space: pre-line; outline: none; }
    </style>
</head>
<body>

<div id="game-container" role="main">
    <h1>Diamant</h1>

    <div id="interaction-zone" class="main-controls hidden">
        <div id="message" role="alert" aria-live="assertive" tabindex="-1">
            Benvenuti. Iniziate il round.
        </div>

        <div id="controls">
            <div id="action-buttons" class="hidden">
                <button id="btn-continue" onclick="processTurn('continue')">VAI AVANTI</button>
                <button id="btn-leave" onclick="processTurn('leave')">ESCI DALLA GROTTA</button>
            </div>

            <div id="confirm-container" class="hidden">
                <button id="btn-confirm" onclick="prepareTurnChoices()">Prosegui</button>
                <button id="btn-status-path" onclick="announcePathStatus()">Stato percorso</button>
                <button id="btn-status-players" onclick="announcePlayersStatus()">Stato giocatori</button>
            </div>

            <div id="next-round-container" class="hidden">
                <button id="btn-next-round" onclick="startRound()">INIZIA PROSSIMO ROUND</button>
            </div>

            <div id="restart-container" class="hidden">
                <button onclick="location.reload()">GIOCA ANCORA</button>
            </div>
        </div>
    </div>

    <div id="setup" class="setup-box">
        <h2>Configurazione Partita</h2>
        <label for="player-select">Scegli il numero di giocatori:</label>
        <select id="player-select" style="font-size: 1.2rem; padding: 5px;">
            <option value="3">3 Giocatori</option>
            <option value="4">4 Giocatori</option>
            <option value="5">5 Giocatori</option>
            <option value="6">6 Giocatori</option>
            <option value="7">7 Giocatori</option>
            <option value="8">8 Giocatori</option>
        </select>
        <br><br>
        <button onclick="startGame()">Inizia la Partita</button>
    </div>

    <div id="board" class="hidden">
        <div class="info-section" role="region" aria-label="Statistiche Round">
            <p id="round-status-text">Round attuale: 1 di 5. Esploratori in grotta: 0.</p>
        </div>

        <div id="player-list" class="player-list" role="region" aria-label="Stato dei Giocatori">
            <h2>Situazione Giocatori:</h2>
            <div id="player-list-content"></div>
        </div>
        
        <div id="path" role="region" aria-label="Percorso">
            <h2>Percorso Esplorato:</h2>
            <div id="path-content"></div>
        </div>
    </div>
</div>

<script>
    let players = [];
    let currentPlayerIndex = 0;
    let round = 1;
    let activeTraps = [];
    let currentPath = [];
    let roundDecisions = [];

    // Mazzo Tesori basato sui tuoi valori (inclusi i duplicati)
    const treasureDeck = [1, 2, 3, 4, 5, 5, 7, 7, 9, 11, 11, 13, 14, 15, 17];
    const trapNames = ['Serpente', 'Ragno', 'Fuoco', 'Masso', 'Gas'];

    function focusMessage() {
        const msg = document.getElementById('message');
        msg.focus();
    }

    function startGame() {
        const count = parseInt(document.getElementById('player-select').value);
        players = [];
        for (let i = 1; i <= count; i++) {
            players.push({ id: i, chest: 0, pocket: 0, inCave: true });
        }
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('interaction-zone').classList.remove('hidden');
        document.getElementById('board').classList.remove('hidden');
        startRound();
    }

    function startRound() {
        if (round > 5) return;
        activeTraps = [];
        currentPath = [];
        players.forEach(p => { p.pocket = 0; p.inCave = true; });
        document.getElementById('path-content').innerHTML = '';
        document.getElementById('next-round-container').classList.add('hidden');
        updateInfoText();
        prepareTurnChoices();
    }

    function updateInfoText() {
        const activeCount = players.filter(p => p.inCave).length;
        document.getElementById('round-status-text').innerText = `Round attuale: ${round} di 5. Esploratori in grotta: ${activeCount}.`;
    }

    function prepareTurnChoices() {
        document.getElementById('confirm-container').classList.add('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
        roundDecisions = [];
        currentPlayerIndex = 0;
        findNextActivePlayer();
    }

    function findNextActivePlayer() {
        while (currentPlayerIndex < players.length && !players[currentPlayerIndex].inCave) {
            currentPlayerIndex++;
        }
        if (currentPlayerIndex < players.length) {
            updateUI(players[currentPlayerIndex].id);
            document.getElementById('message').innerText = "Giocatore " + players[currentPlayerIndex].id + ", scegli: avanti o esci?";
            focusMessage();
        } else {
            executeTurnLogic();
        }
    }

    function processTurn(decision) {
        roundDecisions.push({ playerId: players[currentPlayerIndex].id, action: decision });
        currentPlayerIndex++;
        findNextActivePlayer();
    }

    function executeTurnLogic() {
        document.getElementById('action-buttons').classList.add('hidden');
        let leavingPlayers = players.filter(p => p.inCave && roundDecisions.find(d => d.playerId === p.id).action === 'leave');
        
        if (leavingPlayers.length > 0) {
            currentPath.forEach(card => {
                if (card.remainder > 0) {
                    let share = Math.floor(card.remainder / leavingPlayers.length);
                    leavingPlayers.forEach(p => p.pocket += share);
                    card.remainder %= leavingPlayers.length;
                }
            });
            leavingPlayers.forEach(p => { p.chest += p.pocket; p.pocket = 0; p.inCave = false; });
        }

        if (players.every(p => !p.inCave)) {
            endRound("Tutti i giocatori sono usciti. Il round " + round + " è terminato.");
            return;
        }

        const card = drawCard();
        currentPath.push(card);
        let stayingPlayers = players.filter(p => p.inCave);

        if (card.type === 'treasure') {
            let share = Math.floor(card.value / stayingPlayers.length);
            let rest = card.value % stayingPlayers.length;
            card.remainder = rest;
            stayingPlayers.forEach(p => p.pocket += share);
            document.getElementById('message').innerText = "Tesoro valore " + card.value + ". Ogni giocatore riceve " + share + ". Restano sulla carta " + rest + " diamanti.";
        } else {
            if (activeTraps.includes(card.name)) {
                stayingPlayers.forEach(p => p.pocket = 0);
                endRound("Secondo pericolo: " + card.name + "! Round finito, diamanti del round persi.");
                return;
            } else {
                activeTraps.push(card.name);
                document.getElementById('message').innerText = "Pericolo: " + card.name + ". Primo avvistamento.";
            }
        }

        updateUI();
        document.getElementById('confirm-container').classList.remove('hidden');
        focusMessage();
    }

    function announcePathStatus() {
        if (currentPath.length === 0) {
            document.getElementById('message').innerText = "Percorso vuoto.";
        } else {
            let statusText = "Riepilogo percorso:\n";
            currentPath.forEach((card, index) => {
                statusText += (index + 1) + ". ";
                if (card.type === 'treasure') {
                    statusText += "Tesoro valore " + card.value + ", restano sopra " + card.remainder + ".\n";
                } else {
                    statusText += "Pericolo " + card.name + ".\n";
                }
            });
            document.getElementById('message').innerText = statusText;
        }
        focusMessage();
    }

    function announcePlayersStatus() {
        let statusText = "Situazione Tesori Giocatori:\n";
        players.forEach(p => {
            statusText += `Giocatore ${p.id}: ${p.chest} nel baule, ${p.pocket} nella tasca. ${p.inCave ? 'Ancora in grotta.' : 'Già uscito.'}\n`;
        });
        document.getElementById('message').innerText = statusText;
        focusMessage();
    }

    function drawCard() {
        const isTrap = Math.random() < 0.35;
        if (!isTrap) {
            const val = treasureDeck[Math.floor(Math.random() * treasureDeck.length)];
            return { type: 'treasure', value: val, remainder: 0 };
        } else {
            const name = trapNames[Math.floor(Math.random() * trapNames.length)];
            return { type: 'trap', name: name, remainder: 0 };
        }
    }

    function updateUI(highlightId = null) {
        updateInfoText();
        const listContent = document.getElementById('player-list-content');
        listContent.innerHTML = players.map(p => `
            <div class="player-row ${p.id === highlightId ? 'active-turn' : ''} ${!p.inCave ? 'out' : ''}">
                Giocatore ${p.id}. Stato: ${p.inCave ? 'In grotta' : 'Uscito'}. Tasca: ${p.pocket} diamanti. Baule: ${p.chest} diamanti.
            </div>
        `).join('');

        const pathDiv = document.getElementById('path-content');
        pathDiv.innerHTML = currentPath.map(card => `
            <div style="border: 1px solid black; padding: 5px; margin: 2px; display: inline-block;">
                ${card.type === 'treasure' ? 'Tesoro ' + card.value : 'Pericolo ' + card.name}
            </div>
        `).join('');
    }

    function endRound(msg) {
        updateUI();
        document.getElementById('message').innerText = msg;
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('confirm-container').classList.add('hidden');
        focusMessage();
        round++;
        if (round > 5) {
            players.sort((a,b) => b.chest - a.chest);
            document.getElementById('message').innerText += "\nFine gara. Vince Giocatore " + players[0].id + " con " + players[0].chest + " diamanti.";
            document.getElementById('restart-container').classList.remove('hidden');
        } else {
            document.getElementById('next-round-container').classList.remove('hidden');
        }
    }
</script>
</body>
</html>
