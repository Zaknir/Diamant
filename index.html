<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamant</title>
    <style>
        :root { --bg: #ffffff; --text: #000000; --border: #333333; --highlight: #eeeeee; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; padding: 20px; }
        #game-container { max-width: 800px; margin: auto; }
        .main-controls { border: 3px solid var(--border); padding: 20px; margin-bottom: 20px; background: #f9f9f9; }
        .setup-box, .info-section, .player-list, #path { border: 2px solid var(--border); padding: 15px; margin-bottom: 20px; }
        .player-row { border-bottom: 1px solid var(--border); padding: 10px 0; }
        .active-turn { background: var(--highlight); font-weight: bold; border: 2px solid var(--text); padding: 5px; }
        .out { color: #666666; font-style: italic; }
        button { padding: 18px 28px; font-size: 1.3rem; cursor: pointer; margin: 10px 5px; border: 2px solid var(--text); background: var(--bg); color: var(--text); font-weight: bold; }
        button:hover { background: var(--text); color: var(--bg); }
        .hidden { display: none; }
        #message { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; white-space: pre-line; outline: none; }
        .status-buttons-row { margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
    </style>
</head>
<body>

<div id="game-container" role="main">
    <h1>Diamant</h1>

    <div id="interaction-zone" class="main-controls hidden">
        <div id="message" role="alert" aria-live="assertive" tabindex="-1">
            Benvenuti. Iniziate il round.
        </div>

        <div id="controls">
            <div id="action-buttons" class="hidden">
                <button id="btn-continue" onclick="processTurn('continue')">VAI AVANTI</button>
                <button id="btn-leave" onclick="processTurn('leave')">ESCI DALLA GROTTA</button>
            </div>

            <div id="confirm-container" class="hidden">
                <button id="btn-confirm" onclick="prepareTurnChoices()">Prosegui</button>
            </div>

            <div id="status-container" class="hidden status-buttons-row">
                <button id="btn-status-path" onclick="announcePathStatus()">Stato percorso</button>
                <button id="btn-status-players" onclick="announcePlayersStatus()">Stato giocatori</button>
            </div>

            <div id="next-round-container" class="hidden">
                <button id="btn-next-round" onclick="startRound()">INIZIA PROSSIMO ROUND</button>
            </div>

            <div id="restart-container" class="hidden">
                <button onclick="location.reload()">GIOCA ANCORA</button>
            </div>
        </div>
    </div>

    <div id="setup" class="setup-box">
        <h2>Configurazione Partita</h2>
        <label for="player-select">Scegli il numero di giocatori:</label>
        <select id="player-select" style="font-size: 1.2rem; padding: 5px;">
            <option value="3">3 Giocatori</option>
            <option value="4">4 Giocatori</option>
            <option value="5">5 Giocatori</option>
            <option value="6">6 Giocatori</option>
            <option value="7">7 Giocatori</option>
            <option value="8">8 Giocatori</option>
        </select>
        <br><br>
        <button onclick="startGame()">Inizia la Partita</button>
    </div>

    <div id="board" class="hidden">
        <div class="info-section">
            <p id="round-status-text">Round attuale: 1 di 5. Esploratori in grotta: 0.</p>
        </div>
        <div id="player-list" class="player-list">
            <h2>Situazione Giocatori:</h2>
            <div id="player-list-content"></div>
        </div>
        <div id="path" role="region">
            <h2>Percorso Esplorato:</h2>
            <div id="path-content"></div>
        </div>
    </div>
</div>

<script>
    let players = [];
    let currentPlayerIndex = 0;
    let round = 1;
    let activeTrapsInRound = [];
    let currentPath = [];
    let roundDecisions = [];
    
    const treasureValues = [1, 2, 3, 4, 5, 5, 7, 7, 9, 11, 11, 13, 14, 15, 17];
    const artifactValues = [5, 7, 8, 10, 12];
    let trapDeck = { 'Scorpioni': 3, 'Serpenti': 3, 'Fossa di Lava': 3, 'Massi Rotolanti': 3, 'Trappole Acuminate': 3 };
    let availableArtifactsInDeck = []; // Carte artefatto disponibili nel mazzo corrente

    function focusMessage() {
        document.getElementById('message').focus();
    }

    function startGame() {
        const count = parseInt(document.getElementById('player-select').value);
        players = [];
        for (let i = 1; i <= count; i++) {
            players.push({ id: i, chest: 0, pocket: 0, inCave: true });
        }
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('interaction-zone').classList.remove('hidden');
        document.getElementById('board').classList.remove('hidden');
        startRound();
    }

    function startRound() {
        if (round > 5) return;
        activeTrapsInRound = [];
        currentPath = [];
        players.forEach(p => { p.pocket = 0; p.inCave = true; });
        
        // Aggiungi l'artefatto del round al mazzo pescabile
        availableArtifactsInDeck.push(artifactValues[round-1]);

        document.getElementById('path-content').innerHTML = '';
        document.getElementById('next-round-container').classList.add('hidden');
        document.getElementById('status-container').classList.remove('hidden');
        updateInfoText();
        prepareTurnChoices();
    }

    function updateInfoText() {
        const activeCount = players.filter(p => p.inCave).length;
        document.getElementById('round-status-text').innerText = `Round attuale: ${round} di 5. Esploratori in grotta: ${activeCount}.`;
    }

    function prepareTurnChoices() {
        document.getElementById('confirm-container').classList.add('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
        document.getElementById('status-container').classList.remove('hidden');
        roundDecisions = [];
        currentPlayerIndex = 0;
        findNextActivePlayer();
    }

    function findNextActivePlayer() {
        while (currentPlayerIndex < players.length && !players[currentPlayerIndex].inCave) {
            currentPlayerIndex++;
        }
        if (currentPlayerIndex < players.length) {
            updateUI(players[currentPlayerIndex].id);
            document.getElementById('message').innerText = "Giocatore " + players[currentPlayerIndex].id + ", scegli: avanti o esci?";
            focusMessage();
        } else {
            executeTurnLogic();
        }
    }

    function processTurn(decision) {
        roundDecisions.push({ playerId: players[currentPlayerIndex].id, action: decision });
        currentPlayerIndex++;
        findNextActivePlayer();
    }

    function executeTurnLogic() {
        document.getElementById('action-buttons').classList.add('hidden');
        let leavingPlayers = players.filter(p => p.inCave && roundDecisions.find(d => d.playerId === p.id).action === 'leave');
        
        if (leavingPlayers.length > 0) {
            // Dividi i diamanti rimasti sulle carte tesoro
            currentPath.forEach(card => {
                if (card.type === 'treasure' && card.remainder > 0) {
                    let share = Math.floor(card.remainder / leavingPlayers.length);
                    leavingPlayers.forEach(p => p.pocket += share);
                    card.remainder %= leavingPlayers.length;
                }
                // LOGICA ARTEFATTO: Riscattato solo se esce UN SOLO giocatore
                if (card.type === 'artifact' && card.remainder > 0 && leavingPlayers.length === 1) {
                    leavingPlayers[0].pocket += card.remainder;
                    card.remainder = 0;
                }
            });
            leavingPlayers.forEach(p => { p.chest += p.pocket; p.pocket = 0; p.inCave = false; });
        }

        if (players.every(p => !p.inCave)) {
            endRound("Tutti usciti. Il round " + round + " è terminato.");
            return;
        }

        const card = drawCard();
        currentPath.push(card);
        let stayingPlayers = players.filter(p => p.inCave);

        if (card.type === 'treasure') {
            let share = Math.floor(card.value / stayingPlayers.length);
            let rest = card.value % stayingPlayers.length;
            card.remainder = rest;
            stayingPlayers.forEach(p => p.pocket += share);
            document.getElementById('message').innerText = "Tesoro valore " + card.value + ". Ognuno riceve " + share + ". Restano sulla carta " + rest + " diamanti.";
        } else if (card.type === 'artifact') {
            card.remainder = card.value; // Tutto il valore rimane sulla carta
            document.getElementById('message').innerText = "ARTEFATTO pescato! Valore: " + card.value + ". Sarà raccolto solo da chi uscirà da solo dalla grotta.";
        } else {
            if (activeTrapsInRound.includes(card.name)) {
                trapDeck[card.name] -= 1;
                stayingPlayers.forEach(p => p.pocket = 0);
                endRound("Secondo pericolo: " + card.name + "! Round finito. Una copia di " + card.name + " viene rimossa dal gioco.");
                return;
            } else {
                activeTrapsInRound.push(card.name);
                document.getElementById('message').innerText = "Pericolo: " + card.name + ". Primo avvistamento.";
            }
        }

        updateUI();
        document.getElementById('confirm-container').classList.remove('hidden');
        focusMessage();
    }

    function announcePathStatus() {
        if (currentPath.length === 0) {
            document.getElementById('message').innerText = "Percorso vuoto.";
        } else {
            let statusText = "Riepilogo percorso:\n";
            currentPath.forEach((card, index) => {
                statusText += (index + 1) + ". ";
                if (card.type === 'treasure') statusText += `Tesoro ${card.value} (Resto: ${card.remainder})\n`;
                else if (card.type === 'artifact') statusText += `ARTEFATTO ${card.value} (${card.remainder > 0 ? 'Ancora presente' : 'Già raccolto'})\n`;
                else statusText += `Pericolo ${card.name}\n`;
            });
            document.getElementById('message').innerText = statusText;
        }
        focusMessage();
    }

    function announcePlayersStatus() {
        let statusText = "Situazione Tesori Giocatori:\n";
        players.forEach(p => {
            statusText += `Giocatore ${p.id}: ${p.chest} nel baule, ${p.pocket} nella tasca. ${p.inCave ? 'In grotta.' : 'Uscito.'}\n`;
        });
        document.getElementById('message').innerText = statusText;
        focusMessage();
    }

    function drawCard() {
        let totalTraps = Object.values(trapDeck).reduce((a, b) => a + b, 0);
        let totalArtifacts = availableArtifactsInDeck.length;
        let totalCards = treasureValues.length + totalTraps + totalArtifacts;
        
        let rand = Math.random() * totalCards;

        if (rand < totalTraps) {
            // Pesca trappola
            let availableTraps = [];
            for (let t in trapDeck) { for(let i=0; i<trapDeck[t]; i++) availableTraps.push(t); }
            let name = availableTraps[Math.floor(Math.random() * availableTraps.length)];
            return { type: 'trap', name: name };
        } else if (rand < (totalTraps + totalArtifacts)) {
            // Pesca artefatto
            let val = availableArtifactsInDeck.shift(); // Rimuove dal mazzo globale perché pescato
            return { type: 'artifact', value: val, remainder: val };
        } else {
            // Pesca tesoro
            const val = treasureValues[Math.floor(Math.random() * treasureValues.length)];
            return { type: 'treasure', value: val, remainder: 0 };
        }
    }

    function updateUI(highlightId = null) {
        updateInfoText();
        const listContent = document.getElementById('player-list-content');
        listContent.innerHTML = players.map(p => `
            <div class="player-row ${p.id === highlightId ? 'active-turn' : ''} ${!p.inCave ? 'out' : ''}">
                Giocatore ${p.id}. Tasca: ${p.pocket}, Baule: ${p.chest}. ${p.inCave ? 'In grotta' : 'Uscito'}.
            </div>
        `).join('');

        const pathDiv = document.getElementById('path-content');
        pathDiv.innerHTML = currentPath.map(card => `
            <div style="border: 1px solid black; padding: 5px; margin: 2px; display: inline-block;">
                ${card.type === 'treasure' ? 'T ' + card.value : (card.type === 'artifact' ? 'ART ' + card.value : 'P ' + card.name)}
            </div>
        `).join('');
    }

    function endRound(msg) {
        updateUI();
        document.getElementById('message').innerText = msg;
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('confirm-container').classList.add('hidden');
        document.getElementById('status-container').classList.add('hidden');
        focusMessage();
        round++;
        if (round > 5) {
            players.sort((a,b) => b.chest - a.chest);
            document.getElementById('message').innerText += "\nFine gara. Vince Giocatore " + players[0].id + " con " + players[0].chest + " diamanti.";
            document.getElementById('restart-container').classList.remove('hidden');
        } else {
            document.getElementById('next-round-container').classList.remove('hidden');
        }
    }
</script>
</body>
</html>
